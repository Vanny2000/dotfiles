#!/usr/bin/env zsh

# =============================================================================
# setup-worktree-project
#
# Sets up a Laravel worktree with dependencies, env config, and caches.
#
# Called automatically by claude-worktree after creating a new worktree,
# or can be run standalone in any project directory.
#
# Usage:
#   setup-worktree-project <worktree-path> [main-repo-path]
# =============================================================================

set -e

WORKTREE_PATH="$1"
MAIN_REPO_PATH="$2"

if [[ -z "$WORKTREE_PATH" ]]; then
  echo "Usage: setup-worktree-project <worktree-path> [main-repo-path]"
  exit 1
fi

# Resolve to absolute paths
WORKTREE_PATH=$(cd "$WORKTREE_PATH" && pwd)
if [[ -n "$MAIN_REPO_PATH" ]]; then
  MAIN_REPO_PATH=$(cd "$MAIN_REPO_PATH" && pwd)
fi

cd "$WORKTREE_PATH"

if [[ ! -f "artisan" ]]; then
  echo "âš  Not a Laravel project. Skipping setup."
  exit 0
fi

# =============================================================================
# Helpers
# =============================================================================
symlink_from_main() {
  local file="$1"
  if [[ -n "$MAIN_REPO_PATH" && -f "${MAIN_REPO_PATH}/${file}" && ! -e "${WORKTREE_PATH}/${file}" && ! -L "${WORKTREE_PATH}/${file}" ]]; then
    mkdir -p "$(dirname "${WORKTREE_PATH}/${file}")"
    ln -s "${MAIN_REPO_PATH}/${file}" "${WORKTREE_PATH}/${file}"
    echo "  âœ“ Symlinked ${file} â†’ main repo"
  fi
}

copy_from_main() {
  local file="$1"
  if [[ -n "$MAIN_REPO_PATH" && -f "${MAIN_REPO_PATH}/${file}" && ! -f "${WORKTREE_PATH}/${file}" ]]; then
    mkdir -p "$(dirname "${WORKTREE_PATH}/${file}")"
    cp "${MAIN_REPO_PATH}/${file}" "${WORKTREE_PATH}/${file}"
    echo "  âœ“ Copied ${file} from main repo"
  fi
}

# =============================================================================
# Config files from main repo
# =============================================================================
symlink_from_main ".env"

# =============================================================================
# Composer dependencies
# =============================================================================
echo "ðŸ“¦ Running composer install..."
composer install --no-interaction --quiet 2>/dev/null || composer install --no-interaction

# =============================================================================
# Laravel setup
# =============================================================================

# Generate app key if .env exists but APP_KEY is empty
if [[ -f ".env" ]] && grep -q "^APP_KEY=$" .env; then
  echo "ðŸ”‘ Generating Laravel app key..."
  php artisan key:generate --quiet
fi

# Run migrations if we have a database configured
if [[ -f ".env" ]]; then
  echo "ðŸ—ƒï¸  Running Laravel migrations..."
  php artisan migrate --quiet --no-interaction 2>/dev/null || echo "  âš  Migrations skipped (DB not available)"
fi

# Clear and rebuild caches for a clean state
echo "ðŸ§¹ Clearing Laravel caches..."
php artisan optimize:clear --quiet 2>/dev/null

# =============================================================================
# Node dependencies (for frontend assets if present)
# =============================================================================
if [[ -f "package.json" ]]; then
  if [[ -f "bun.lockb" || -f "bun.lock" ]]; then
    PM="bun"
  elif [[ -f "pnpm-lock.yaml" ]]; then
    PM="pnpm"
  elif [[ -f "yarn.lock" ]]; then
    PM="yarn"
  else
    PM="npm"
  fi

  echo "ðŸ“¦ Running ${PM} install..."
  $PM install --silent 2>/dev/null || $PM install
fi

echo ""
echo "âœ“ Laravel worktree setup complete"
